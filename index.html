<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecretGram Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- НОВЫЙ БЛОК: Правила безопасности Firebase Firestore -->
    <script type="text/security-rules">
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
    
        // Вспомогательная функция для проверки аутентификации
        function isAuthenticated() {
          return request.auth != null;
        }

        // --- 1. ПРИВАТНЫЕ ДАННЫЕ (Профиль пользователя) ---
        // Путь: /artifacts/{appId}/users/{userId}/profiles/{document}
        // Разрешить чтение/запись только владельцу профиля
        match /artifacts/{appId}/users/{userId}/profiles/{document=**} {
          allow read, write: if isAuthenticated() && request.auth.uid == userId;
        }

        // --- 2. ПУБЛИЧНЫЕ ДАННЫЕ (Чат и Список пользователей) ---
        // Путь: /artifacts/{appId}/public/data/{path}
        // Разрешить чтение/запись любому аутентифицированному пользователю (включая анонимных)
        match /artifacts/{appId}/public/data/{path=**} {
          allow read, write: if isAuthenticated();
        }
      }
    }
    </script>
    <!-- КОНЕЦ НОВОГО БЛОКА -->
    
    <style>
        /* Глобальные стили */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #c9d1d9;
        }

        /* Общий контейнер */
        .app-container {
            width: 100%;
            height: 100vh;
            max-height: 800px;
            background: #161b22;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        
        /* Мобильный макет */
        @media (max-width: 767px) {
            .app-container {
                max-width: 400px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            }
            #chats-list-view, #chat-view {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 20;
            }
            #chat-view {
                z-index: 30;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
            }
            #chat-view.active {
                transform: translateX(0);
            }
        }
        
        /* ПК/Планшет макет */
        @media (min-width: 768px) {
             .app-container {
                max-width: 1200px;
                height: 90vh;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                display: flex;
             }
             #chats-list-view {
                flex-basis: 350px;
                flex-shrink: 0;
                border-right: 1px solid #21262d;
                position: relative;
                transform: translateX(0) !important;
                z-index: 20;
             }
             #chat-view {
                flex-grow: 1;
                display: flex !important;
                transform: translateX(0) !important;
             }
             #chat-view.chat-placeholder {
                display: flex;
                align-items: center;
                justify-content: center;
                color: #6b7280;
                font-size: 1.25rem;
             }
        }

        /* Общие компоненты */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ff4081;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chat-input-container {
            border-top: 1px solid #21262d;
            padding: 1rem;
            display: flex;
            align-items: center;
            background-color: #161b22;
            flex-shrink: 0;
        }
        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
            word-wrap: break-word;
            line-height: 1.4;
            opacity: 0; /* Скрыто для анимации */
            transform: translateY(10px) scale(0.95); /* Сдвинуто для анимации */
            animation: fadeInMessage 0.3s ease-out forwards;
        }
        .my-message {
            background-color: #8c20f0;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }
        .other-message {
            background-color: #21262d;
            color: #c9d1d9;
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column-reverse;
            overflow-anchor: auto;
        }
        .send-icon {
            fill: #ff4081;
            transition: fill 0.2s;
        }
        .send-icon:hover {
            fill: #a020f0;
        }
        .profile-modal-content {
            background-color: #161b22;
            width: 100%;
            max-width: 400px;
            height: 100%;
            max-height: 800px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        .profile-header-bg {
            background: linear-gradient(135deg, #a020f0, #ff4081);
            height: 150px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 5;
        }
        .profile-section {
            padding: 1rem 1.5rem;
            border-top: 1px solid #21262d;
        }
        .chat-list-item-pc {
            padding: 10px 12px;
            transition: background-color 0.2s ease; /* Анимация для списка чатов */
        }
        
        /* Анимация появления сообщения */
        @keyframes fadeInMessage {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Стили для формы аутентификации */
        #auth-screen {
            background: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .auth-gradient-btn {
            background: linear-gradient(90deg, #a020f0, #ff4081);
            transition: opacity 0.2s, transform 0.1s;
        }
        .auth-gradient-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp, runTransaction, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('debug'); // Активировать для отладки

        // --- Глобальные переменные Firebase ---
        let appId = 'default-app-id'; 
        let firebaseConfig = {};
        let initialAuthToken = null;
        
        // Переменные Firebase
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Состояние чата
        const PUBLIC_CHAT_ID = 'general';
        let currentChatType = 'public'; 
        let currentChatRecipient = null; 
        let currentChatId = null; 
        let currentRecipientNickname = 'Выберите чат'; 
        
        // Состояние приложения
        let userNickname = localStorage.getItem('userNickname') || '';
        let userProfile = {};
        let allUsers = []; 

        // --- Пути Firestore ---
        // ПРИВАТНЫЙ: Профиль пользователя
        const PROFILE_DOC_PATH = (uid) => `artifacts/${appId}/users/${uid}/profiles/myProfile`;
        // ПУБЛИЧНЫЙ: Сообщения в общем чате
        const CHAT_COLLECTION_PATH = (id) => `artifacts/${appId}/public/data/chats/${id}/messages`;
        // ПУБЛИЧНЫЙ: Список всех пользователей (для поиска и транзакций никнейма)
        const ALL_USERS_COLLECTION_PATH = `artifacts/${appId}/public/data/users`;

        // Элементы UI
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const messengerApp = document.getElementById('messenger-app');
        const profileModal = document.getElementById('profile-modal');
        const nicknameDisplay = document.getElementById('current-nickname');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message-btn');
        const chatHeaderTitle = document.getElementById('chat-header-title');
        const chatsListViewContent = document.getElementById('chats-list-view-content');
        const chatView = document.getElementById('chat-view');
        const backToChatsButton = document.getElementById('back-to-chats');
        const searchInput = document.getElementById('search-input');
        const searchResultsContainer = document.getElementById('search-results');
        const profileNicknameInput = document.getElementById('profile-nickname-display');
        const profileError = document.getElementById('profile-error');

        // Элементы аутентификации
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authErrorDisplay = document.getElementById('auth-error');
        const authActionBtn = document.getElementById('auth-action-btn');
        const authSwitchBtn = document.getElementById('auth-switch-btn');
        const authTitle = document.getElementById('auth-title');

        let isLoginMode = true; // Текущий режим: true=Вход, false=Регистрация

        // --- Логика аутентификации ---

        /**
         * Переключает между режимами "Вход" и "Регистрация".
         */
        function switchAuthMode() {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                authTitle.textContent = 'Вход в SecretGram';
                authActionBtn.textContent = 'Войти';
                authSwitchBtn.textContent = 'Нет аккаунта? Зарегистрироваться';
            } else {
                authTitle.textContent = 'Регистрация';
                authActionBtn.textContent = 'Зарегистрироваться';
                authSwitchBtn.textContent = 'Уже есть аккаунт? Войти';
            }
            authErrorDisplay.textContent = ''; // Сброс ошибки
        }

        /**
         * Выполняет вход или регистрацию с обходом ошибки Firebase Console.
         */
        async function handleAuthAction() {
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            authErrorDisplay.textContent = '';
            
            if (!email || password.length < 6) {
                authErrorDisplay.textContent = 'Введите корректный email и пароль (минимум 6 символов).';
                return;
            }
            
            authActionBtn.disabled = true;
            authActionBtn.textContent = isLoginMode ? 'Вход...' : 'Регистрация...';

            try {
                // Попытка входа/регистрации через Email/Password
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Auth error:", error);
                let errorMessage = 'Неизвестная ошибка.';
                
                if (error.code === 'auth/operation-not-allowed') {
                    // FIX: Улучшенное сообщение об ошибке для operation-not-allowed + АНОНИМНЫЙ ОБХОД
                    errorMessage = 'Провайдер аутентификации Email/Password отключен. Для полноценной работы ВКЛЮЧИТЕ его в Firebase Console. Выполняю анонимный вход для продолжения работы.';
                    
                    // АНОНИМНЫЙ ОБХОДНОЙ ПУТЬ: Позволяет пользователю начать работу немедленно
                    try {
                        await signInAnonymously(auth);
                        // Если анонимный вход успешен, onAuthStateChanged обработает переход на следующий экран.
                        return; 
                    } catch (e) {
                        errorMessage += " Ошибка анонимного входа: " + e.message;
                    }

                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Неверный email или пароль.';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Этот email уже используется.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Слишком слабый пароль.';
                }

                // Показываем ошибку только если обходной путь не сработал
                authErrorDisplay.textContent = `Ошибка: ${errorMessage}`;
            } finally {
                // Восстанавливаем кнопку, только если не произошел успешный вход/обход
                if (!auth.currentUser) {
                    authActionBtn.disabled = false;
                    authActionBtn.textContent = isLoginMode ? 'Войти' : 'Зарегистрироваться';
                }
            }
        }
        
        /**
         * Выход пользователя из системы.
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                // После выхода onAuthStateChanged переключит на 'auth'
                profileModal.classList.add('hidden');
            } catch (e) {
                console.error("Ошибка при выходе:", e);
            }
        }

        // --- Инициализация Firebase и Аутентификация ---

        /**
         * Инициализирует Firebase и аутентифицирует пользователя.
         */
        async function initializeFirebase() {
            try {
                // Использование глобальных переменных
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                try {
                    firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                } catch (e) {
                    console.error("Не удалось проанализировать конфигурацию Firebase:", e);
                }
                initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // --- Обязательный шаг для среды Canvas (начальный вход/выход) ---
                try {
                    // 1. Попытка начальной аутентификации
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    // 2. Принудительный выход для отображения экрана входа/регистрации
                    if (auth.currentUser) {
                        await signOut(auth);
                    }
                } catch(e) {
                    // Если initial auth fails, это нормально, перейдем на auth screen
                    console.warn("Initial authentication failed, proceeding to auth screen:", e);
                }
                // --- КОНЕЦ Обязательный шаг ---

                // Слушатель состояния аутентификации
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await ensureUserProfile(userId);
                        renderApp('messenger');
                        // Проверка isAuthReady, прежде чем настраивать слушатели
                        if (isAuthReady) {
                            setupUserAndChatListeners(); 
                            openChat(PUBLIC_CHAT_ID, 'public', 'Общий чат');
                        }
                    } else {
                        userId = null;
                        // Если нет пользователя, показываем экран аутентификации
                        renderApp('auth');
                        if (unsubscribeChat) unsubscribeChat(); // Отписываемся от чата
                    }
                    // Устанавливаем isAuthReady в true после первого onAuthStateChanged
                    if (!isAuthReady) {
                        isAuthReady = true;
                        if (auth.currentUser) {
                             setupUserAndChatListeners(); 
                             openChat(PUBLIC_CHAT_ID, 'public', 'Общий чат');
                        }
                    }
                    loadingScreen.classList.add('hidden');
                });

            } catch (error) {
                console.error("Ошибка инициализации приложения:", error);
                loadingScreen.classList.add('hidden');
                renderApp('auth');
            }
        }

        /**
         * Проверяет и/или создает профиль пользователя и гарантирует уникальный никнейм.
         */
        async function ensureUserProfile(uid) {
            const profileRef = doc(db, PROFILE_DOC_PATH(uid));
            try {
                const docSnap = await getDoc(profileRef);
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    userNickname = userProfile.nickname;
                } else {
                    // Создание базового профиля
                    let defaultNickname;
                    if (auth.currentUser.email) {
                        // Используем email, если он есть (для аутентификации E/P)
                        const emailPrefix = auth.currentUser.email.split('@')[0].replace(/[^a-z0-9]/gi, '');
                        defaultNickname = `${emailPrefix}_${uid.substring(0, 4)}`;
                    } else {
                        // Для анонимного входа
                        defaultNickname = `Anon_${uid.substring(0, 4)}`;
                    }

                    userNickname = defaultNickname; 
                    userProfile = { uid: uid, nickname: defaultNickname, createdAt: serverTimestamp(), email: auth.currentUser.email || 'N/A' };
                    await setDoc(profileRef, userProfile);
                    await updateNickname(defaultNickname, true); // Регистрация в публичной коллекции
                }
                localStorage.setItem('userNickname', userNickname);
                updateUIForUser();
            } catch (e) {
                console.error("Ошибка при получении/создании профиля:", e);
            }
        }

        /**
         * Обновляет публичный никнейм и проверяет его уникальность с помощью транзакции.
         */
        async function updateNickname(newNickname, isInitialCreation = false) {
            newNickname = newNickname.trim();
            if (!newNickname || newNickname.length < 3) {
                 profileError.textContent = 'Никнейм должен содержать не менее 3 символов.';
                 profileError.classList.add('text-red-400');
                 return false;
            }
            
            const profileRef = doc(db, PROFILE_DOC_PATH(userId));
            // Использование toLowerCase() для никнейма в качестве ID публичного документа
            const userPublicRef = doc(db, ALL_USERS_COLLECTION_PATH, newNickname.toLowerCase());

            if (!isInitialCreation) {
                profileError.textContent = 'Проверка уникальности...';
                profileError.classList.remove('text-red-400', 'text-green-400');
                profileError.classList.add('text-yellow-400');
            }
            
            try {
                await runTransaction(db, async (transaction) => {
                    const publicSnap = await transaction.get(userPublicRef);
                    
                    // Проверка, занят ли никнейм другим пользователем
                    if (publicSnap.exists() && publicSnap.data().uid !== userId) {
                        throw new Error(`Никнейм "${newNickname}" уже занят.`);
                    }

                    // Если это не первоначальное создание и никнейм изменился, удаляем старую публичную запись
                    if (!isInitialCreation && userProfile.nickname && userProfile.nickname !== newNickname) {
                        const oldUserPublicRef = doc(db, ALL_USERS_COLLECTION_PATH, userProfile.nickname.toLowerCase());
                        transaction.delete(oldUserPublicRef);
                    }

                    userProfile.nickname = newNickname;
                    
                    // Обновляем приватный профиль и публичную запись
                    transaction.set(profileRef, userProfile, { merge: true }); 
                    transaction.set(userPublicRef, { uid: userId, nickname: newNickname, lastUpdated: serverTimestamp() }); 
                });

                userNickname = newNickname;
                localStorage.setItem('userNickname', userNickname);
                updateUIForUser();
                
                if (!isInitialCreation) {
                    profileError.textContent = 'Никнейм успешно обновлен!';
                    profileError.classList.remove('text-yellow-400');
                    profileError.classList.add('text-green-400');
                }
                return true;

            } catch (e) {
                if (!isInitialCreation) {
                    profileError.textContent = `Ошибка: ${e.message}`;
                    profileError.classList.remove('text-yellow-400');
                    profileError.classList.add('text-red-400');
                }
                console.error("Ошибка транзакции обновления никнейма:", e);
                return false;
            }
        }


        // --- Слушатели и Рендеринг данных ---

        /**
         * Устанавливает слушатели для всех публичных пользователей и текущего чата.
         */
        function setupUserAndChatListeners() {
            // Подписка на список пользователей
            const usersQ = query(collection(db, ALL_USERS_COLLECTION_PATH));
            onSnapshot(usersQ, (snapshot) => {
                allUsers = snapshot.docs.map(d => d.data());
                // console.log("Users updated:", allUsers.length); // Отладка
            }, (error) => {
                console.error("Ошибка подписки на пользователей:", error);
                // Показываем ошибку, если правила безопасности неверны
                if (error.code === 'permission-denied') {
                    console.error("ПРОВЕРЬТЕ ПРАВИЛА БЕЗОПАСНОСТИ FIRESTORE: Чтение ALL_USERS_COLLECTION_PATH запрещено.");
                }
            });
            
            renderChatsList([{ chatId: PUBLIC_CHAT_ID, nickname: 'Общий чат' }]);
        }

        let unsubscribeChat = null;
        function setupChatMessagesListener(chatId) {
            if (unsubscribeChat) {
                unsubscribeChat();
            }

            const messagesQ = query(
                collection(db, CHAT_COLLECTION_PATH(chatId)),
                orderBy('timestamp', 'desc'),
                limit(50)
            );

            // Сохраняем предыдущий список ID сообщений для определения новых сообщений
            let previousMessageIds = new Set(); 

            unsubscribeChat = onSnapshot(messagesQ, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMessages(messages, previousMessageIds);
                // Обновляем список ID после рендеринга
                previousMessageIds = new Set(messages.map(m => m.id)); 
            }, (error) => {
                console.error("Ошибка подписки на сообщения:", error);
                renderMessages([]);
                // Показываем ошибку, если правила безопасности неверны
                if (error.code === 'permission-denied') {
                    chatMessagesContainer.innerHTML = '<div class="text-center text-red-400 font-bold">ОШИБКА ДОСТУПА. Проверьте правила безопасности Firestore для чатов.</div>';
                }
            });
        }

        function renderChatsList(chats) {
            chatsListViewContent.innerHTML = '';
            const publicChat = document.createElement('div');
            // Используем transition-colors для анимации при наведении
            publicChat.className = `chat-list-item-pc flex items-center p-3 rounded-lg cursor-pointer transition-colors duration-150 ease-in-out ${currentChatId === PUBLIC_CHAT_ID ? 'bg-[#30363d]' : 'hover:bg-[#21262d]'}`;
            publicChat.innerHTML = `
                <div class="w-10 h-10 flex items-center justify-center rounded-full bg-[#ff4081] text-white font-bold text-lg mr-3">#</div>
                <div class="flex-grow">
                    <div class="text-sm font-semibold">Общий чат</div>
                    <div class="text-xs text-[#8b949e]">Все пользователи</div>
                </div>
            `;
            publicChat.addEventListener('click', () => {
                openChat(PUBLIC_CHAT_ID, 'public', 'Общий чат');
            });
            chatsListViewContent.appendChild(publicChat);
        }

        /**
         * Генерирует HTML для сообщений и применяет анимацию к новым.
         * @param {Array<Object>} messages Список объектов сообщений.
         * @param {Set<string>} previousMessageIds ID сообщений, которые уже были на экране.
         */
        function renderMessages(messages, previousMessageIds) {
            // Создаем новый фрагмент, чтобы минимизировать перерисовку DOM
            const fragment = document.createDocumentFragment();
            if (messages.length === 0) {
                chatMessagesContainer.innerHTML = '<div class="text-center text-[#8b949e]">Начните общение!</div>';
                return;
            }
            
            messages.forEach(msg => {
                const isMyMessage = msg.senderId === userId;
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${isMyMessage ? 'justify-end' : 'justify-start'}`;
                
                const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '...';

                messageElement.innerHTML = `
                    <div class="message-bubble ${isMyMessage ? 'my-message' : 'other-message'}">
                        <div class="font-bold text-xs ${isMyMessage ? 'text-white/80' : 'text-purple-400'}">
                            ${isMyMessage ? 'Вы' : msg.senderNickname || 'Неизвестный'}
                        </div>
                        <p class="text-sm">${msg.text}</p>
                        <div class="text-[10px] text-right ${isMyMessage ? 'text-white/60' : 'text-[#8b949e]/80'} mt-1">${time}</div>
                    </div>
                `;
                
                // Применяем анимацию только к новым сообщениям
                if (!previousMessageIds.has(msg.id)) {
                    // Активируем анимацию, устанавливая animation-delay, чтобы сообщения не появлялись все сразу
                    const delay = (messages.length - 1 - messages.indexOf(msg)) * 0.05; // Небольшая задержка для каскадного эффекта
                    messageElement.querySelector('.message-bubble').style.animationDelay = `${delay}s`;
                } else {
                    // Если сообщение уже было, делаем его видимым без анимации
                    messageElement.querySelector('.message-bubble').style.opacity = '1';
                    messageElement.querySelector('.message-bubble').style.transform = 'translateY(0) scale(1)';
                }
                
                fragment.appendChild(messageElement);
            });

            // Заменяем содержимое одним разом
            chatMessagesContainer.innerHTML = '';
            chatMessagesContainer.appendChild(fragment);
        }

        // --- Логика чата и UI ---

        function openChat(chatId, type, nickname) {
            currentChatId = chatId;
            currentChatType = type;
            currentRecipientNickname = nickname;

            chatHeaderTitle.textContent = nickname;
            
            messageInput.value = '';
            messageInput.focus();
            
            setupChatMessagesListener(chatId);

            chatView.classList.remove('chat-placeholder');
            chatView.classList.add('active');
        }
        
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentChatId || !userId) return;

            // Временно блокируем кнопку и очищаем поле
            messageInput.value = ''; 
            messageInput.disabled = true;
            sendMessageButton.disabled = true;

            const chatRef = collection(db, CHAT_COLLECTION_PATH(currentChatId));
            
            const message = {
                text: text,
                timestamp: serverTimestamp(),
                senderId: userId,
                senderNickname: userNickname,
                chatId: currentChatId
            };

            try {
                // Используем setDoc с doc() для авто-ID, как в предыдущем коде
                await setDoc(doc(chatRef), message); 
            } catch (e) {
                console.error("Ошибка при отправке сообщения:", e);
                // Показываем ошибку, если правила безопасности неверны
                if (e.code === 'permission-denied') {
                    console.error("ПРОВЕРЬТЕ ПРАВИЛА БЕЗОПАСНОСТИ FIRESTORE: Запись в чат запрещена.");
                    // Можно отобразить временное сообщение в UI, но оставим только в консоли
                }
                messageInput.value = text;
            } finally {
                messageInput.disabled = false;
                sendMessageButton.disabled = false;
                messageInput.focus();
            }
        }

        function updateUIForUser() {
            nicknameDisplay.textContent = userNickname;
            document.getElementById('current-user-id').textContent = `ID: ${userId}`;
            profileNicknameInput.value = userNickname;
            document.getElementById('nickname-avatar').textContent = userNickname.charAt(0).toUpperCase();
            document.getElementById('profile-nickname-display-static').textContent = userNickname;
        }

        function handleSearch() {
            const queryText = searchInput.value.trim().toLowerCase();
            searchResultsContainer.innerHTML = '';
            
            if (queryText.length < 2) return;

            const filteredUsers = allUsers.filter(user => 
                user.nickname && user.nickname.toLowerCase().includes(queryText) && user.uid !== userId
            );

            if (filteredUsers.length === 0) {
                searchResultsContainer.innerHTML = '<div class="p-3 text-center text-[#8b949e]">Никто не найден.</div>';
                return;
            }

            filteredUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'flex items-center p-3 hover:bg-[#21262d] cursor-pointer rounded-lg transition duration-150 ease-in-out';
                userElement.innerHTML = `
                    <div class="w-8 h-8 flex items-center justify-center rounded-full bg-pink-500 text-white font-bold text-sm mr-3">${user.nickname.charAt(0).toUpperCase()}</div>
                    <div class="flex-grow">
                        <div class="text-sm font-semibold">${user.nickname}</div>
                        <div class="text-xs text-[#8b949e] truncate">ID: ${user.uid}</div>
                    </div>
                `;
                searchResultsContainer.appendChild(userElement);
            });
        }

        /**
         * Управляет видимостью экранов.
         * @param {'loading'|'auth'|'messenger'} state 
         */
        function renderApp(state) {
            loadingScreen.classList.add('hidden');
            authScreen.classList.add('hidden');
            messengerApp.classList.add('hidden');

            if (state === 'loading') {
                loadingScreen.classList.remove('hidden');
            } else if (state === 'auth') {
                authScreen.classList.remove('hidden');
            } else if (state === 'messenger') {
                messengerApp.classList.remove('hidden');
            }
        }
        
        function closeChatView() {
            if (window.innerWidth < 768) {
                chatView.classList.remove('active');
            }
        }


        // --- Настройка обработчиков событий и защиты ---

        function setupEventListeners() {
            // Аутентификация
            authActionBtn.addEventListener('click', handleAuthAction);
            authSwitchBtn.addEventListener('click', switchAuthMode);
            document.getElementById('sign-out-btn').addEventListener('click', handleSignOut);
            
            // Отправка сообщения
            sendMessageButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Профиль
            document.getElementById('save-nickname-btn').addEventListener('click', () => {
                updateNickname(profileNicknameInput.value);
            });
            document.getElementById('open-profile-btn').addEventListener('click', () => {
                profileModal.classList.remove('hidden');
                profileNicknameInput.value = userNickname;
                profileError.textContent = '';
                updateUIForUser(); // Обновление аватара
            });
            document.getElementById('close-profile-btn').addEventListener('click', () => {
                profileModal.classList.add('hidden');
            });
            
            // Мобильная навигация
            backToChatsButton.addEventListener('click', closeChatView);

            // Поиск
            searchInput.addEventListener('input', handleSearch);

            // Инициализация режима аутентификации по умолчанию
            switchAuthMode();
        }

        /**
         * Включает базовую защиту от DevTools (НЕ является надежной защитой)
         */
        function setupAntiInspection() {
            // Запрет правого клика
            document.addEventListener('contextmenu', (e) => e.preventDefault());

            // Запрет F12, Ctrl+Shift+I/J/C
            document.addEventListener('keydown', (e) => {
                // F12
                if (e.key === 'F12') {
                    e.preventDefault();
                }
                // Ctrl+Shift+I, J, C
                if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) {
                    e.preventDefault();
                }
            });
        }


        // --- Запуск приложения ---
        window.onload = () => {
            setupAntiInspection();
            setupEventListeners();
            initializeFirebase();
        };

    </script>
</head>
<body>

    <!-- Модальное окно профиля -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4 hidden">
        <div class="profile-modal-content rounded-xl shadow-2xl">
            <!-- Заголовок -->
            <div class="profile-header-bg"></div>
            <div class="relative z-10 p-5 pt-8 flex flex-col items-center">
                <div class="w-24 h-24 flex items-center justify-center rounded-full bg-purple-600 text-4xl font-bold text-white border-4 border-[#161b22] mb-3 shadow-lg">
                    <span id="nickname-avatar">U</span>
                </div>
                <h2 id="profile-nickname-display-static" class="text-xl font-bold text-white">
                    Nickname
                </h2>
            </div>

            <!-- Раздел редактирования никнейма -->
            <div class="profile-section relative">
                <h3 class="text-lg font-semibold mb-3">Настройки профиля</h3>
                <div class="flex flex-col space-y-3">
                    <label for="profile-nickname-display" class="text-sm text-[#8b949e]">Уникальный никнейм:</label>
                    <input type="text" id="profile-nickname-display" maxlength="20"
                           class="w-full px-3 py-2 rounded-lg bg-[#0d1117] border border-[#21262d] focus:border-[#ff4081] focus:ring focus:ring-[#ff4081] focus:ring-opacity-50 text-white"
                           placeholder="Введите новый никнейм">
                    <button id="save-nickname-btn" class="w-full bg-[#ff4081] hover:bg-[#a020f0] text-white font-bold py-2 rounded-lg transition duration-150 ease-in-out shadow-md">
                        Сохранить никнейм
                    </button>
                    <p id="profile-error" class="text-sm text-red-400 h-5"></p>
                </div>
            </div>

            <div class="profile-section relative pt-0 flex flex-col space-y-2">
                <button id="sign-out-btn" class="w-full border border-red-500 hover:bg-red-900 text-red-400 font-bold py-2 rounded-lg transition duration-150 ease-in-out">
                    Выйти
                </button>
                <button id="close-profile-btn" class="w-full border border-[#21262d] hover:bg-[#21262d] text-[#8b949e] font-bold py-2 rounded-lg transition duration-150 ease-in-out">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <!-- 0. Экран загрузки -->
    <div id="loading-screen" class="absolute inset-0 bg-black flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-white">Подключение...</p>
    </div>

    <!-- 1. Экран аутентификации (Новый) -->
    <div id="auth-screen" class="p-8 hidden">
        <h1 id="auth-title" class="text-3xl font-bold text-white mb-6 text-center">Вход в SecretGram</h1>
        
        <div class="flex flex-col space-y-4">
            <input type="email" id="auth-email"
                   class="w-full px-4 py-3 rounded-lg bg-[#0d1117] border border-[#21262d] focus:border-[#ff4081] text-white placeholder-gray-500 transition duration-150"
                   placeholder="Email">
            <input type="password" id="auth-password"
                   class="w-full px-4 py-3 rounded-lg bg-[#0d1117] border border-[#21262d] focus:border-[#ff4081] text-white placeholder-gray-500 transition duration-150"
                   placeholder="Пароль (мин. 6 символов)">
            
            <p id="auth-error" class="text-sm text-red-400 h-5"></p>

            <button id="auth-action-btn" class="auth-gradient-btn text-white font-bold py-3 rounded-lg shadow-lg">
                Войти
            </button>

            <button id="auth-switch-btn" class="text-sm text-[#8b949e] hover:text-white transition duration-150 pt-2">
                Нет аккаунта? Зарегистрироваться
            </button>
        </div>

        <p class="text-center text-xs text-[#8b949e] mt-8">
            :: Powered by ThisTeam ::
        </p>
    </div>


    <!-- 2. Основное приложение мессенджера -->
    <div id="messenger-app" class="app-container hidden">

        <!-- Список чатов -->
        <div id="chats-list-view" class="w-full h-full flex flex-col bg-[#161b22]">
            <!-- Header (Список чатов) -->
            <div class="p-4 bg-[#161b22] border-b border-[#21262d] flex justify-between items-center flex-shrink-0 z-10">
                <h1 class="text-2xl font-bold text-white">Чаты</h1>
                <button id="open-profile-btn" class="flex items-center space-x-2 p-2 bg-[#21262d] hover:bg-[#30363d] rounded-full transition duration-150 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-purple-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <span id="current-nickname" class="font-semibold text-sm text-white">Nickname</span>
                </button>
            </div>

            <!-- Поиск -->
            <div class="p-4 flex-shrink-0">
                <input type="text" id="search-input" placeholder="Найти пользователя по никнейму..."
                       class="w-full px-4 py-2 rounded-full bg-[#0d1117] border border-[#21262d] focus:border-[#ff4081] focus:ring-1 focus:ring-[#ff4081] focus:ring-opacity-50 text-white placeholder-gray-500">
            </div>

            <!-- Результаты поиска -->
            <div id="search-results" class="px-4 pb-4">
                <!-- Сюда будут добавляться результаты поиска -->
            </div>

            <!-- Список чатов -->
            <div id="chats-list-view-content" class="flex-grow overflow-y-auto px-4 space-y-2 pb-4">
                <!-- Сюда будет добавлен "Общий чат" -->
            </div>
            
            <div class="p-2 border-t border-[#21262d] text-center text-xs text-[#8b949e] flex-shrink-0">
                <span id="current-user-id" class="block truncate">ID: ...</span>
                :: Powered by ThisTeam ::
            </div>
        </div>

        <!-- Окно чата -->
        <div id="chat-view" class="w-full h-full flex-col bg-[#161b22] md:flex chat-placeholder" style="display: none;">
            
            <!-- Header (Окно чата) -->
            <div class="p-4 bg-[#161b22] border-b border-[#21262d] flex items-center flex-shrink-0">
                <button id="back-to-chats" class="md:hidden mr-3 p-1 rounded-full hover:bg-[#21262d] text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"></path><path d="M12 19l-7-7 7-7"></path></svg>
                </button>
                <div class="w-10 h-10 flex items-center justify-center rounded-full bg-[#ff4081] text-white font-bold text-lg mr-3">
                    #
                </div>
                <h2 id="chat-header-title" class="text-xl font-bold text-white truncate">Общий чат</h2>
            </div>

            <!-- Область сообщений -->
            <div id="chat-messages" class="chat-messages">
                <div class="text-center text-[#8b949e]">Выберите чат, чтобы начать общение.</div>
            </div>

            <!-- Ввод сообщения -->
            <div id="chat-input-area" class="chat-input-container flex-shrink-0">
                <textarea id="message-input" rows="1"
                       class="flex-grow resize-none overflow-y-auto px-4 py-2 rounded-xl bg-[#0d1117] border border-[#21262d] focus:border-[#ff4081] focus:ring focus:ring-[#ff4081] focus:ring-opacity-50 text-white placeholder-gray-500 mr-3"
                       placeholder="Напишите сообщение..." oninput="this.style.height='auto'; this.style.height=(this.scrollHeight)+'px';"></textarea>
                <button id="send-message-btn" class="p-3 rounded-full bg-transparent hover:bg-[#21262d] transition duration-150 ease-in-out flex-shrink-0">
                    <svg class="send-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3v8.99L17 12 2.01 12.01z" />
                    </svg>
                </button>
            </div>
        </div>

    </div>
</body>
</html>
