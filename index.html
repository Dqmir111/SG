<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecretGram Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .app-container {
            width: 100%;
            max-width: 400px;
            height: 100vh;
            max-height: 800px; /* Max height for mobile feel */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            background: #161b22; /* Slightly lighter dark background for the app */
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .header-bg {
            background: linear-gradient(135deg, #a020f0, #ff4081); /* Gradient for the header */
            height: 120px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }
        /* Custom spinner for the loading screen */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ff4081; /* Pink */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chat-input-container {
            border-top: 1px solid #21262d;
            padding: 1rem;
            display: flex;
            align-items: center;
            background-color: #161b22;
        }
        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .my-message {
            background-color: #8c20f0; /* Purple gradient part */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }
        .other-message {
            background-color: #21262d; /* Dark gray for others */
            color: #c9d1d9;
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column-reverse; /* New messages at the bottom */
        }
        /* Style for the Send button icon (SVG) */
        .send-icon {
            fill: #ff4081; /* Pink color for the icon */
            transition: fill 0.2s;
        }
        .send-icon:hover {
            fill: #a020f0; /* Purple on hover */
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('debug'); // Активировать для отладки

        // Глобальные переменные, предоставленные Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Переменные Firebase
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Состояние приложения
        let userNickname = localStorage.getItem('userNickname') || '';
        const CURRENT_CHAT_ID = 'general'; // Всегда используем один общий чат
        const PROFILE_DOC_PATH = (uid) => `artifacts/${appId}/users/${uid}/profiles/myProfile`;
        const CHAT_COLLECTION_PATH = `artifacts/${appId}/public/data/chats/${CURRENT_CHAT_ID}/messages`;
        
        const views = {
            loading: document.getElementById('loading-view'),
            nickname: document.getElementById('nickname-view'),
            chat: document.getElementById('chat-view'),
        };
        const nicknameInput = document.getElementById('nickname-input');
        const chatMessagesDiv = document.getElementById('chat-messages');

        // --- Утилиты ---
        
        function showView(viewName) {
            Object.values(views).forEach(view => {
                if (view) view.classList.add('hidden');
            });
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '...';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        // --- Главная логика Firebase ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Слушатель состояния аутентификации
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated. UID:", userId);
                        // Проверяем, есть ли у пользователя никнейм
                        await loadUserProfile();
                        // Устанавливаем готовность только после загрузки профиля
                        isAuthReady = true;
                        if (userNickname) {
                            showView('chat');
                            startMessageListener();
                        } else {
                            showView('nickname');
                        }
                    } else {
                        // Если пользователь не аутентифицирован, но токен есть, попробуем войти
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Иначе - анонимный вход
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                // Показываем заглушку с ошибкой, если не удалось подключиться
                views.loading.innerHTML = `<div class="text-white text-center p-8">Ошибка подключения. Пожалуйста, проверьте консоль.</div>`;
            }
        }
        
        async function loadUserProfile() {
            if (!userId) return;
            try {
                const profileRef = doc(db, PROFILE_DOC_PATH(userId));
                const profileSnap = await getDoc(profileRef);
                
                if (profileSnap.exists() && profileSnap.data().nickname) {
                    userNickname = profileSnap.data().nickname;
                    localStorage.setItem('userNickname', userNickname);
                    document.getElementById('current-nickname-display').textContent = userNickname;
                    console.log("Profile loaded:", userNickname);
                } else {
                    // Если локально был ник, но в БД нет (например, новый аккаунт), очищаем локальный
                    if (userNickname) {
                        userNickname = '';
                        localStorage.removeItem('userNickname');
                    }
                    console.log("Profile not found. Prompting for nickname.");
                }

            } catch (e) {
                console.error("Error loading user profile:", e);
                // На случай ошибки, сбрасываем никнейм и просим ввести заново
                userNickname = '';
                localStorage.removeItem('userNickname');
            }
        }

        async function saveNickname(nickname) {
            if (!userId || !db) return;
            const trimmedNickname = nickname.trim();
            if (trimmedNickname.length < 2 || trimmedNickname.length > 20) {
                alertModal("Никнейм должен быть от 2 до 20 символов.");
                return;
            }

            try {
                const profileRef = doc(db, PROFILE_DOC_PATH(userId));
                await setDoc(profileRef, {
                    nickname: trimmedNickname,
                    createdAt: serverTimestamp(),
                    userId: userId 
                }, { merge: true });

                userNickname = trimmedNickname;
                localStorage.setItem('userNickname', userNickname);
                document.getElementById('current-nickname-display').textContent = userNickname;

                showView('chat');
                startMessageListener(); // Запускаем слушатель после успешного сохранения
            } catch (e) {
                console.error("Error saving nickname:", e);
                alertModal("Не удалось сохранить никнейм. Попробуйте еще раз.");
            }
        }

        // --- Логика Чата ---

        function startMessageListener() {
            if (!db || !isAuthReady) return;

            const messagesCollectionRef = collection(db, CHAT_COLLECTION_PATH);
            const q = query(messagesCollectionRef, orderBy('createdAt', 'desc'), limit(50));

            onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                renderMessages(messages);
            }, (error) => {
                console.error("Error listening to messages:", error);
                alertModal("Ошибка загрузки сообщений. Пожалуйста, проверьте ваше подключение.");
            });
        }

        function renderMessages(messages) {
            chatMessagesDiv.innerHTML = ''; // Очистка
            
            // Сообщения приходят в обратном порядке (latest first), отображаем их снизу вверх
            messages.reverse().forEach(msg => {
                const isMine = msg.userId === userId;
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isMine ? 'justify-end' : 'justify-start'}`;

                const nicknameElement = document.createElement('div');
                nicknameElement.className = `text-xs ${isMine ? 'text-gray-400 text-right' : 'text-purple-400 text-left'} mb-1`;
                nicknameElement.textContent = msg.nickname || 'Неизвестный';
                
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isMine ? 'my-message' : 'other-message'}`;
                
                const textElement = document.createElement('div');
                textElement.textContent = msg.text;
                textElement.className = 'text-sm';

                const timeElement = document.createElement('div');
                timeElement.className = `text-xs mt-1 ${isMine ? 'text-gray-200' : 'text-gray-400'} opacity-75 text-right`;
                timeElement.textContent = formatTimestamp(msg.createdAt);

                bubble.appendChild(textElement);
                bubble.appendChild(timeElement);

                const container = document.createElement('div');
                container.appendChild(nicknameElement);
                container.appendChild(bubble);

                messageDiv.appendChild(container);
                chatMessagesDiv.appendChild(messageDiv);
            });
            
            // Прокрутка вниз при первом рендере или отправке своего сообщения
            // Если вы используете flex-direction: column-reverse, прокрутка не нужна
            // chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        async function sendMessage(text) {
            if (!db || !userId || !userNickname || !text.trim()) return;

            const messagesCollectionRef = collection(db, CHAT_COLLECTION_PATH);
            const message = {
                text: text.trim(),
                createdAt: serverTimestamp(),
                userId: userId,
                nickname: userNickname
            };

            try {
                await runTransaction(db, async (transaction) => {
                    // Просто добавляем новое сообщение
                    const newDocRef = doc(messagesCollectionRef); 
                    transaction.set(newDocRef, message);
                });
                document.getElementById('message-input').value = ''; // Очистка
            } catch (e) {
                console.error("Error sending message:", e);
                alertModal("Не удалось отправить сообщение.");
            }
        }
        
        // --- Модальное окно (замена alert()) ---

        function alertModal(message) {
            const modal = document.getElementById('custom-alert-modal');
            const messageEl = document.getElementById('alert-message');
            messageEl.textContent = message;
            modal.classList.remove('hidden');
        }

        // --- Инициализация и обработчики событий ---

        window.onload = initializeFirebase;

        // Обработчик сохранения никнейма
        document.getElementById('start-chat-button').addEventListener('click', () => {
            saveNickname(nicknameInput.value);
        });
        nicknameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveNickname(nicknameInput.value);
            }
        });

        // Обработчик отправки сообщения
        document.getElementById('send-message-button').addEventListener('click', () => {
            const input = document.getElementById('message-input');
            sendMessage(input.value);
        });
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const input = document.getElementById('message-input');
                sendMessage(input.value);
            }
        });

        // Обработчик закрытия модального окна
        document.getElementById('close-alert-button').addEventListener('click', () => {
            document.getElementById('custom-alert-modal').classList.add('hidden');
        });
        
        // Обработчик сброса профиля
        document.getElementById('reset-profile-button').addEventListener('click', async () => {
            if(confirm("Вы уверены, что хотите выйти? Вам придется заново вводить никнейм.")) {
                localStorage.removeItem('userNickname');
                userNickname = '';
                userId = null;
                showView('loading');
                await signOut(auth);
                // Перезапускаем инициализацию, чтобы снова войти анонимно
                // В onAuthStateChanged сработает signInAnonymously
            } else {
                // Используем alertModal как замену confirm
                alertModal("Выход отменен.");
            }
        });
        
        // Замена confirm на модальное окно (так как confirm() запрещен)
        function confirm(message) {
             const confirmModal = document.getElementById('custom-confirm-modal');
             const confirmMessageEl = document.getElementById('confirm-message');
             const confirmYesBtn = document.getElementById('confirm-yes-button');
             const confirmNoBtn = document.getElementById('confirm-no-button');

             confirmMessageEl.textContent = message;
             confirmModal.classList.remove('hidden');

             return new Promise(resolve => {
                 confirmYesBtn.onclick = () => {
                     confirmModal.classList.add('hidden');
                     resolve(true);
                 };
                 confirmNoBtn.onclick = () => {
                     confirmModal.classList.add('hidden');
                     resolve(false);
                 };
             });
         }
        
    </script>
</head>
<body>

    <div class="app-container">
        
        <div class="header-bg"></div>

        <!-- Модальное окно для Alert (замена alert()) -->
        <div id="custom-alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
            <div class="bg-[#161b22] p-6 rounded-xl shadow-2xl w-full max-w-sm text-white">
                <p id="alert-message" class="mb-4 text-center text-sm"></p>
                <button id="close-alert-button" class="w-full py-2 bg-[#ff4081] hover:bg-[#a020f0] rounded-lg font-semibold transition">ОК</button>
            </div>
        </div>
        
        <!-- Модальное окно для Confirm (замена confirm()) -->
        <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
            <div class="bg-[#161b22] p-6 rounded-xl shadow-2xl w-full max-w-sm text-white">
                <p id="confirm-message" class="mb-4 text-center text-sm"></p>
                <div class="flex justify-between space-x-4">
                    <button id="confirm-no-button" class="w-1/2 py-2 border border-gray-600 text-gray-400 hover:bg-gray-800 rounded-lg transition">Отмена</button>
                    <button id="confirm-yes-button" class="w-1/2 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition">Да, выйти</button>
                </div>
            </div>
        </div>

        <!-- 1. Экран загрузки (Loading View) -->
        <div id="loading-view" class="absolute inset-0 bg-[#0d1117] flex flex-col items-center justify-center z-40 transition-opacity duration-300">
            <div class="loader mb-4"></div>
            <p class="text-white text-lg">Подключение к SecretGram...</p>
        </div>

        <!-- 2. Экран ввода никнейма (Nickname View) -->
        <div id="nickname-view" class="hidden absolute inset-0 bg-[#0d1117] flex flex-col items-center justify-center z-30 p-8">
            <svg class="mb-6 w-16 h-16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#ff4081" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87m-4-12a4 4 0 0 1 0 7.75"></path></svg>
            <h2 class="text-white text-2xl font-bold mb-8">Добро пожаловать</h2>
            <p class="text-gray-400 text-center mb-6">Ваш ник будет виден всем в чате.</p>
            <div class="w-full flex space-x-2">
                <input id="nickname-input" type="text" placeholder="Введите ваш ник..." class="flex-grow p-3 rounded-xl bg-[#21262d] text-white border border-[#21262d] focus:border-[#a020f0] focus:outline-none transition" maxlength="20">
                <button id="start-chat-button" class="p-3 bg-gradient-to-r from-[#a020f0] to-[#ff4081] text-white rounded-xl font-semibold shadow-lg hover:shadow-[#ff4081]/50 transition">
                    Начать чат
                </button>
            </div>
        </div>

        <!-- 3. Экран Чата (Chat View) -->
        <div id="chat-view" class="hidden flex-grow flex flex-col">
            
            <!-- Header -->
            <header class="p-4 relative z-10 flex justify-between items-center text-white">
                <h1 class="text-xl font-bold">SecretGram</h1>
                <div class="flex items-center space-x-2">
                    <span id="current-nickname-display" class="text-sm font-semibold text-gray-300"></span>
                    <button id="reset-profile-button" title="Выйти и сбросить профиль" class="p-1 rounded-full text-gray-400 hover:text-[#ff4081] transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    </button>
                </div>
            </header>

            <!-- Tabs -->
            <div class="relative z-10 flex text-center text-white border-b border-[#21262d]">
                <div class="w-1/2 p-3 font-semibold border-b-2 border-[#ff4081] text-[#ff4081] cursor-pointer">
                    Общий
                </div>
                <div class="w-1/2 p-3 text-gray-400 cursor-default">
                    Секретный
                </div>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages" class="chat-messages">
                <!-- Сообщения будут рендериться здесь -->
            </div>

            <!-- Input Area -->
            <div class="chat-input-container">
                <input id="message-input" type="text" placeholder="Написать сообщение..." class="flex-grow p-3 rounded-xl bg-[#21262d] text-white border border-[#21262d] focus:border-[#a020f0] focus:outline-none transition">
                <button id="send-message-button" class="ml-2 p-3 rounded-full bg-transparent hover:bg-[#21262d] transition">
                    <!-- Send Icon (SVG) -->
                    <svg class="send-icon w-6 h-6 transform rotate-45 -mt-1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.01 21.01L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <div class="fixed bottom-0 text-xs text-gray-600 p-1">:: Powered by ThisTeam ::</div>
</body>
</html>
